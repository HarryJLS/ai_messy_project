# Code Review - 代码审查工作流

基于 diff 的全面代码审查工作流，自动检测项目语言并应用对应规范。

## 核心概念

| 语言 | 检测方式 | 规范 |
|------|---------|------|
| Java | `*.java` | 阿里巴巴 Java 开发规范 |
| Go | `*.go` | 字节跳动 Go 开发规范 |
| Frontend | `*.tsx`, `*.jsx` | React/TypeScript 规范 |
| Python | `*.py` | FastAPI/异步 规范 |

**设计原则**：
- **只审查 diff**：仅检查变更代码，不审查未改动部分
- **上下文辅助**：读取完整文件理解上下文，但只对 diff 提反馈
- **影响分析**：检查变更是否影响其他模块
- **自动修复**：提供具体的修复建议

---

## 工作流: code-review

**指令**: `/code-review`

**描述**: 对代码变更进行全面审查，生成审查报告

### 阶段 1: 获取 Diff

**默认行为**：直接执行 `git diff` 获取未提交的更改

```bash
# 默认执行
git diff
```

**如果 `git diff` 为空**：询问用户选择其他来源

| 来源 | 命令 |
|------|------|
| 已暂存的更改 | `git diff --cached` |
| 与主分支对比 | `git diff main..HEAD` |
| 最近一次提交 | `git diff HEAD~1` |
| PR 变更 | `gh pr diff {pr-number}` |

⛔ **门控**: 必须获取到非空 diff 才能继续

---

### 阶段 2: 解析与检测

1. **解析 diff**：
   - 提取变更文件列表
   - 提取新增/修改的代码行
   - 记录行号范围

2. **检测语言/领域**：

```
文件扩展名检测（优先）：
├─ *.java → Java 领域
├─ *.go → Go 领域
├─ *.tsx/*.jsx → Frontend 领域
├─ *.py → Backend(Python) 领域
└─ 其他 → 仅通用检查

目录路径检测（次优先）：
├─ server/, rag/ → Backend
├─ designer/ → Frontend
└─ cli/ → Go
```

3. **加载检查清单**：
   - 根据检测结果读取对应的 `*.md` 检查清单
   - 多语言项目加载多个清单

---

### 阶段 3: 初始化报告

创建审查报告文件：

```bash
REPORT_DIR="/tmp/claude/$(echo $PWD | tr '/' '-')/reviews"
mkdir -p "$REPORT_DIR"
REPORT="${REPORT_DIR}/code-review-$(date +%Y%m%d-%H%M%S).md"
```

初始化报告模板：

```markdown
# Code Review Report

**日期**: {当前日期}
**审查者**: Code Review Agent
**来源**: {diff 来源}
**变更文件**: {数量}
**检测领域**: {Java/Go/Frontend/Backend}
**状态**: 进行中

## 汇总

| 分类 | 检查项 | 通过 | 失败 | 发现 |
|------|--------|------|------|------|
| 安全 | 0 | 0 | 0 | 0 |
| 代码质量 | 0 | 0 | 0 | 0 |
| 代码格式 | 0 | 0 | 0 | 0 |
| 影响分析 | 0 | 0 | 0 | 0 |

## 详细发现

{审查过程中逐步添加}
```

---

### 阶段 4: 执行审查

#### 4.1 通用检查（所有语言）

| 分类 | 检查项 |
|------|--------|
| 安全 | 硬编码密钥、动态代码执行、命令注入 |
| 代码质量 | 调试语句、TODO注释、空catch块 |
| LLM异味 | 占位实现、过度抽象 |
| 简化 | 重复逻辑、不必要复杂度 |
| 控制流 | if嵌套≤3层、for嵌套≤2层、条件表达式≤3个、循环内禁止查询 |

#### 4.2 语言特定检查

**Java（阿里巴巴规范）**：
- 代码格式：方法≤70行、单行≤120字符
- 命名规约：布尔禁is、常量全大写
- OOP规约：@Override、包装类equals
- 并发处理：禁Executors、线程命名
- 异常日志：空catch、SLF4J门面
- 安全规约：SQL注入、XSS防护
- 控制流：if嵌套≤3层、for嵌套≤2层、条件表达式≤3个、禁止循环内SQL查询

**Go（字节跳动规范）**：
- 代码格式：函数≤50行、单行≤120字符、gofmt
- 依赖注入：构造函数形式
- 错误处理：必须处理、%w包装
- 并发安全：race检测、goroutine泄漏、锁释放
- 性能优化：slice/map预分配、strings.Builder
- 控制流：if嵌套≤3层、for嵌套≤2层、条件表达式≤3个、禁止循环内DB查询

**每个检查项执行**：
1. 在 diff 中搜索匹配模式
2. 读取完整文件获取上下文
3. 判断是否违规
4. 记录发现到报告

---

### 阶段 5: 影响分析

检查变更是否影响其他代码：

| 变更类型 | 检查方式 |
|---------|---------|
| 导出函数/类修改 | 搜索其他文件的 import/调用 |
| API 接口变更 | 搜索调用方 |
| 共享类型修改 | 搜索使用处 |
| 配置结构变更 | 搜索依赖该配置的代码 |

**如发现未处理的影响**：记录为 High 级别发现

---

### 阶段 6: 记录发现

每个问题使用以下格式：

```markdown
### [{分类}] {检查项名称}

**状态**: FAIL
**严重级别**: Critical | High | Medium | Low

#### 违规

- **文件**: `path/to/file.ext`
- **行号**: 42-48
- **代码**:
```
// 问题代码片段
```
- **问题**: {问题说明}
- **建议**: {如何修复}
```

---

### 阶段 7: 完成报告

1. **更新汇总表**：统计各分类的检查结果

2. **生成执行摘要**：

```markdown
## 执行摘要

**审查完成**: {时间戳}
**总发现**: {数量}

### 必须修复（Critical）
1. {问题1}
2. {问题2}

### 建议修复（High）
1. {问题1}
2. {问题2}

### 影响分析结果
- {影响说明}

### 总体建议
{基于审查结果的整体建议}
```

3. **更新状态**：`进行中` → `完成`

4. **告知用户报告位置**

---

## 完成后输出

```
✅ 代码审查完成！

📊 汇总:
• 检查文件: {N} 个
• 发现问题: {M} 个
  - Critical: {x}
  - High: {y}
  - Medium: {z}
  - Low: {w}

📄 报告: {报告路径}

⚠️ 需要立即处理:
1. {Critical 问题列表}
```

---

## 快速命令

| 场景 | 命令 |
|------|------|
| 审查未提交更改 | `git diff \| /code-review` |
| 审查 PR | `gh pr diff 123 \| /code-review` |
| 审查最近提交 | `git diff HEAD~1 \| /code-review` |
| 审查与主分支差异 | `git diff main..HEAD \| /code-review` |

---

## 严重级别说明

| 级别 | 说明 | 行动 |
|------|------|------|
| Critical | 安全漏洞、数据丢失风险 | 必须立即修复 |
| High | 潜在 bug、性能问题 | 合并前修复 |
| Medium | 代码质量、可维护性 | 建议修复 |
| Low | 风格、最佳实践 | 可选修复 |

---

## 检查清单索引

| 文件 | 适用语言 | 规范来源 |
|------|---------|---------|
| `java.md` | Java | 阿里巴巴 Java 开发手册 |
| `go.md` | Go | 字节跳动 Go 开发规范 |
| `frontend.md` | React/TS | React/TypeScript 最佳实践 |
| `backend.md` | Python | FastAPI/异步 最佳实践 |

---

## 注意事项

1. **只审查 diff**：不对未变更代码提出问题
2. **上下文理解**：读取完整文件，但反馈只针对变更部分
3. **影响检查**：变更涉及导出/API 时，搜索受影响代码
4. **具体建议**：每个问题必须包含文件、行号、修复建议
5. **优先级排序**：Critical 问题优先报告
6. **增量更新**：每个分类检查完立即更新报告
